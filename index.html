<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TonCrash</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            background: linear-gradient(135deg, #0a192f, #000000, #1a1a1a, #2c3e50);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            color: white;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 75%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 25%; }
            100% { background-position: 0% 50%; }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-gif {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin-bottom: 40px;
        }

        .loading-bar-container {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b39bd, #4d4bcf);
            width: 0%;
            animation: loadingProgress 2s ease-out forwards;
        }

        @keyframes loadingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .balance-container {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .balance-text {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ton-logo {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .user-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-icon:hover {
            transform: scale(1.1);
        }

        .add-btn {
            background: #3b39bd;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #4d4bcf;
        }

        .bet-counter {
            position: fixed;
            top: 16px;
            right: 16px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .game-container {
            max-width: 480px;
            margin: 80px auto 20px;
            padding: 0 16px;
        }

        .background-window {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .game-window {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 24px;
            position: relative;
            height: 380px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin-bottom: 16px;
        }

        .history-strip {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(20, 20, 20, 0.8);
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 8px;
            overflow-x: auto;
            z-index: 15;
            scrollbar-width: none;
        }

        .history-strip::-webkit-scrollbar {
            display: none;
        }

        .history-item {
            min-width: 60px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            border: 2px solid;
            background: rgba(0, 0, 0, 0.4);
        }

        .history-item.low {
            border-color: #c23232;
            color: #c23232;
        }

        .history-item.medium {
            border-color: #48a61c;
            color: #48a61c;
        }

        .history-item.high {
            border-color: #ffae0d;
            color: #ffae0d;
        }

        .grid-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .red-line {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transition: filter 0.3s;
        }

        .red-line.break-blur {
            filter: blur(8px);
        }

        .rocket-gif {
            position: absolute;
            width: 120px;
            height: 120px;
            object-fit: contain;
            pointer-events: none;
            transition: all 0.05s linear;
        }

        .rocket-gif.break-blur {
            filter: blur(8px);
        }

        .multiplier {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, calc(-50% - 50px));
            font-size: 64px;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
            z-index: 10;
            transition: color 0.3s;
        }

        .multiplier.crashed {
            color: #ff0000;
        }

        .multiplier.break-blur {
            filter: blur(8px);
        }

        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 30px rgba(255, 255, 255, 0.5);
        }

        .bet-button {
            width: 100%;
            padding: 18px;
            background: #3b39bd;
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 4px 12px rgba(59, 57, 189, 0.4);
        }

        .bet-button:hover {
            background: #4d4bcf;
        }

        .bet-button.hidden {
            display: none;
        }

        .players-window {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 24px;
            padding: 20px;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 2px solid #3b39bd;
            margin-bottom: 16px;
        }

        .players-online {
            font-size: 14px;
            font-weight: 600;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .players-total {
            font-size: 14px;
            font-weight: 600;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .players-window::-webkit-scrollbar {
            width: 8px;
        }

        .players-window::-webkit-scrollbar-track {
            background: rgba(40, 40, 40, 0.5);
            border-radius: 4px;
        }

        .players-window::-webkit-scrollbar-thumb {
            background: #3b39bd;
            border-radius: 4px;
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 2px solid #3b39bd;
            transition: all 0.3s;
        }

        .player-item.highlight {
            border-color: gold;
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
        }

        .player-item.cashed-out {
            background: rgba(74, 222, 128, 0.15);
        }

        .player-item.lost {
            background: rgba(255, 0, 0, 0.15);
        }

        .player-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-name {
            font-size: 14px;
            font-weight: 500;
        }

        .player-bet {
            font-size: 13px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .player-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-cashout {
            font-size: 14px;
            font-weight: 600;
            color: #4ade80;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .gift-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .footer-window {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 24px 24px 0 0;
            padding: 40px 20px;
            margin-top: 16px;
            text-align: center;
            box-shadow: 0 -4px 32px rgba(0, 0, 0, 0.4);
        }

        .footer-title {
            margin-bottom: 20px;
        }

        .footer-title img {
            width: 200px;
            height: auto;
            object-fit: contain;
        }

        .promo-input {
            width: 100%;
            padding: 16px;
            background: rgba(40, 40, 40, 0.8);
            border: 2px solid #3b39bd;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            text-align: center;
            outline: none;
            transition: border 0.2s;
        }

        .promo-input:focus {
            border-color: #4d4bcf;
        }

        .modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 20, 20, 0.98);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: block;
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 16px;
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid rgba(59, 57, 189, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            outline: none;
            margin-bottom: 12px;
        }

        .modal-input:focus {
            border-color: #3b39bd;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .toggle {
            width: 50px;
            height: 28px;
            background: rgba(60, 60, 60, 0.8);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: #3b39bd;
        }

        .toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 12px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }

        .toggle.active .toggle-slider {
            left: 24px;
        }

        .modal-button {
            width: 100%;
            padding: 16px;
            background: #3b39bd;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .tab-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(30, 30, 30, 0.8);
            border: none;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: #3b39bd;
            color: white;
        }

        .inventory-placeholder {
            padding: 40px 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
            line-height: 1.6;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .gift-item {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.2s;
        }

        .gift-item.selected {
            border-color: #3b39bd;
        }

        .gift-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .gift-value {
            font-size: 13px;
            font-weight: 600;
            color: #4ade80;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .win-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 20, 20, 0.98);
            border-radius: 24px 24px 0 0;
            padding: 40px 24px;
            z-index: 3000;
            text-align: center;
            animation: slideUp 0.3s ease;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
        }

        .win-modal.show {
            display: block;
        }

        .win-modal-handle {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .win-gift {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin: 0 auto 20px;
        }

        .win-amount {
            font-size: 36px;
            font-weight: 900;
            color: #4ade80;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 20, 20, 0.98);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
        }

        .payment-modal.show {
            display: block;
        }

        .payment-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .payment-button {
            width: 100%;
            padding: 16px;
            background: #3b39bd;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .payment-button:hover {
            background: #4d4bcf;
        }

        .cashout-button {
            width: 100%;
            padding: 18px;
            background: #4ade80;
            border: none;
            border-radius: 16px;
            color: #0f0f0f;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
            transition: background 0.2s;
            display: none;
        }

        .cashout-button:hover {
            background: #5bef91;
        }

        .cashout-button.show {
            display: block;
        }

        .overlay-dim {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            display: none;
        }

        .overlay-dim.show {
            display: block;
        }

        .username-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 20, 0.98);
            border-radius: 24px;
            padding: 40px 24px;
            z-index: 4000;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
        }

        .username-modal.show {
            display: block;
        }

        .history-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 80vh;
            background: rgba(20, 20, 20, 0.98);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .history-modal.show {
            display: block;
        }

        .history-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .history-item-type {
            font-size: 14px;
            font-weight: 600;
        }

        .history-item-type.deposit {
            color: #4ade80;
        }

        .history-item-type.withdraw {
            color: #ff6b6b;
        }

        .history-item-type.bet {
            color: #ffae0d;
        }

        .support-button {
            width: 100%;
            padding: 16px;
            background: #3b39bd;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            text-decoration: none;
            display: block;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <img class="loading-gif" id="loadingGif" src="" alt="Loading">
        <div class="loading-bar-container">
            <div class="loading-bar"></div>
        </div>
    </div>

    <div class="overlay-dim" id="overlayDim"></div>

    <div class="username-modal" id="usernameModal">
        <div class="modal-title">Добро пожаловать!</div>
        <input type="text" class="modal-input" id="usernameInput" placeholder="Введите Telegram ник">
        <button class="modal-button" onclick="saveUsername()">Продолжить</button>
    </div>

    <div class="balance-container">
        <span class="balance-text" id="balance">
            1.00
            <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
        </span>
        <img src="https://png.klev.club/uploads/posts/2024-05/png-klev-club-6ann-p-polzovatel-png-1.png" alt="User" class="user-icon" onclick="openHistoryModal()">
        <button class="add-btn" onclick="openPaymentModal()">+</button>
    </div>

    <div class="bet-counter" id="betCounter">
        Ставка #1
    </div>

    <div class="game-container">
        <div class="background-window">
            <div class="game-window" id="gameWindow">
                <div class="history-strip" id="historyStrip"></div>
                <canvas class="grid-canvas" id="gridCanvas"></canvas>
                <svg class="red-line" id="redLine" width="100%" height="100%" viewBox="0 0 480 380" preserveAspectRatio="none">
                    <path id="linePath" d="" stroke="#00ff00" stroke-width="4" fill="none" vector-effect="non-scaling-stroke"
                          style="filter: drop-shadow(0 0 15px #00ff00) drop-shadow(0 0 30px #00ff00) drop-shadow(0 0 45px #00ff00);"/>
                </svg>
                <img class="rocket-gif" id="rocket" src="" alt="Rocket">
                <div class="multiplier" id="multiplier">1.00x</div>
                <div class="countdown-overlay" id="countdown" style="display: none;">
                    <div class="countdown-number" id="countdownNumber">5</div>
                </div>
            </div>

            <button class="bet-button" id="betButton" onclick="openBetModal()">Поставить</button>
            <button class="cashout-button" id="cashoutBtn" onclick="cashOut()">Забрать</button>

            <div class="players-window" id="playersWindow">
                <div class="players-header">
                    <div class="players-online">
                        Онлайн: <span id="onlineCount">0</span>
                    </div>
                    <div class="players-total">
                        Сумма: <span id="totalAmount">0.00</span>
                        <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
                    </div>
                </div>
                <div id="playersList"></div>
            </div>

            <div class="footer-window">
                <div class="footer-title">
                    <img src="https://i.postimg.cc/XN9jNVR8/Snimok-ekrana-2025-11-24-200044-Photoroom.png" alt="TonCrash">
                </div>
                <input type="text" class="promo-input" id="promoInput" placeholder="Введите промокод">
            </div>
        </div>
    </div>

    <div class="modal" id="betModal">
        <div class="modal-handle"></div>
        <div class="modal-title">Ставка</div>
        <div class="tab-container">
            <button class="tab active" id="tonTab" onclick="switchTab('ton')">TON</button>
            <button class="tab" id="inventoryTab" onclick="switchTab('inventory')">Инвентарь</button>
        </div>
        <div id="tonContent">
            <input type="number" class="modal-input" id="betAmount" placeholder="Сумма ставки в TON" step="0.01">
            <div class="toggle-container">
                <span>Авто кэш</span>
                <div class="toggle" id="autoCashToggle" onclick="toggleAutoCash()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <input type="number" class="modal-input" id="autoCashAmount" placeholder="При достижении" step="0.01" style="display: none;">
            <button class="modal-button" onclick="placeBet()">Поставить</button>
        </div>
        <div id="inventoryContent" style="display: none;">
            <div class="inventory-placeholder" id="inventoryPlaceholder">
                Отправьте любой подарок/nft @suphiex<br>и он отобразится в профиле
            </div>
            <div class="inventory-grid" id="inventoryGrid" style="display: none;"></div>
            <button class="modal-button" id="giftBetButton" onclick="placeGiftBet()" style="display: none;">Поставить</button>
        </div>
    </div>

    <div class="win-modal" id="winModal">
        <div class="win-modal-handle"></div>
        <img class="win-gift" id="winGift" src="https://i.postimg.cc/Rq567hTG/1f4b0.png" alt="Gift">
        <div class="win-amount" id="winAmount">
            0.00
            <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
        </div>
        <button class="modal-button" onclick="closeWinModal()">Продолжить</button>
    </div>

    <div class="payment-modal" id="paymentModal">
        <div class="modal-handle"></div>
        <div class="modal-title">Пополнение / Вывод</div>
        <div class="payment-tabs">
            <button class="tab active" id="depositTab" onclick="switchPaymentTab('deposit')">Пополнить</button>
            <button class="tab" id="withdrawTab" onclick="switchPaymentTab('withdraw')">Вывести</button>
        </div>
        <div id="depositContent">
            <a href="https://t.me/send?start=IVC1RvnZnd43" class="payment-button" target="_blank">Пополнить через CryptoBot</a>
        </div>
        <div id="withdrawContent" style="display: none;">
            <input type="number" class="modal-input" id="withdrawAmount" placeholder="Сумма вывода" step="0.01">
            <input type="text" class="modal-input" id="withdrawAddress" placeholder="Адрес TON кошелька">
            <button class="modal-button" onclick="withdraw()">Вывести</button>
        </div>
    </div>

    <div class="history-modal" id="historyModal">
        <div class="modal-handle"></div>
        <div class="modal-title">История транзакций</div>
        <div id="historyList"></div>
        <a href="https://t.me/suphiex" class="support-button" target="_blank">Тех поддержка</a>
    </div>

    <script>
        const usernames = ['Smexoed', 'sophiexeonfan', 'Love11Ak', 'rizzaaak', 'malisss', 'ggyohj', 'Bellysimo5', 'user3_141', 'smolnikovvvvv', 'WhiteHumanDark', 'berwlins', 'JohnDoebutdontDoe', 'Movevome', 'donyaa_gaaazzz', 'mlxlmx', 'I_lovee_Thanos', 'cTTuCTTokoUno', 'xzwxw', 'Icegerco', 'vei_1005', 'qaoe1', 'Onotolion', 'AnykaqX', 'usokc', 'Fuh1nter', 'zweeqrw', 'Emir20347', 'Pyctoslov', 'izceebeam', 'AND_FROSH', 'Gabsila', 'Hranitelsemeni', 'Sruhdr', 'Angels_Cut', 's1rna', 'strelok430', 'LadaSilver', 'ElfAldarion', 'HELL_666_XD', 'AMOGUSHKA', 'ukd_0', 'akylkaaa', 'sy1kkp', 'Darv1zzzBR', 'femetistov', 'iuHZxluq', 'robsopw', 'JolyneKujoJojo', 'Tiorichaan', 'Vasul66', 'azyzyzyy', 'lievlner', 'id_swatmvd', 'Emitruebankst', 'KENDIK_epta', 'NOSEXG', 'Zenvogtr', 'Menyavsyezaebal', 'Darina192015', 'Anyasss444', 'mmaayy8', 'iwoho', 'pirozhock13', 'Marv_Jr', 'fuebdndjuf', 'lenalll6', 'AKHQU', 'elizabethhatextt', 'katk_a', 'SaniaCement', 'wowtryiq', 'YV_ZXZ', 'Vlad26126', 'rahmatilllo', 'ksivusd', 'Krayyz', 'Ekaterinabraun', 'Aytiistt', 'weyq4', 'Za11ur', 'jamshid_makhm', 'lepeshkkaa', 'abdu11ayefva', 'f0rwwhaT', 'wrn77777', 'Snezhokov', 'ssshhhadowww', 'rmlvnns', 'imxumku', 'menzneebet1', 'difereq', 'Kitty_poy', 'Why_e100', 'losinghealth', 'm1llezzz', 'Saka_su', 'skrwwv', 'FOREVARRRRR', 'Rrr_Nnn1', 'SillyCat_fan', 'Viper_z3', 'Bebe_Rehnna', 'sigma_bima_ma', 'loveme_plase', 'tuffiz', 'wlwwlwpp', 'Kaminoko_ice', 'oIdworld', 'Pivo_1_milkiwey', 'consteint_dead', 'menedwe', 'kavidochek', 'genaaaaaaaaaaaadiiii', 'vakho_brooklin_gg', 'ZackActiogl0', 'eweryyn', 'n53ssh', 'Mnufo', 'evimilf', 'a9ykk', 'milvicss', 'mm_okak', 'garryunix', 'xaneetaaax', 'Venno_Laupaev', 'zimehka', 'amiishk1a', 'villmelz', 'kismwwm', 'Myfkakp', 'qqwk67', 'c9TeROO5', 'Garlic_in_a_hat', 'andreykashn', 'vtrrx_1', 'AtRCra9', 'W1ZAR16', 'Onetdozajd', 'Zanetti888', 'Mandy_princess', 'ninehundred900', 'danyamon', 'Shvern', 'tyyskw', 'weshlwe', 'Ddduudddeee', 'Molodoyfarhor', 'Elyor_Navruz', 'shdwrzesquad', 'Gugwr', 'NeloWin', 'nuuwes', 'babyHeru', 'Douwantacookie', 'kke9rmai'];

        const rocketGif = 'https://i.postimg.cc/6pmvCr9r/ezgif-78c292e779aaf7ba.gif';

        // Game state variables
        let selectedRocketGif = '';
        let balance = 1.00;
        let inventory = [];
        let currentBet = null;
        let pendingBet = null;
        let autoCash = false;
        let autoCashAmount = 0;
        let multiplier = 1.00;
        let gameRunning = false;
        let players = [];
        let linePoints = [];
        let totalBetAmount = 0;
        let history = [];
        let transactionHistory = [];
        let backgroundOffset = 0;
        let isAtCenter = false;

        // Advanced betting algorithm variables
        let betCount = 0;
        let betHistory = []; // последние 10 ставок для отслеживания роста
        let hasBetSpikeOccurred = false; // флаг того, что скачок уже произошел

        const canvas = document.getElementById('gridCanvas');
        const ctx = canvas.getContext('2d');
        const svgNS = "http://www.w3.org/2000/svg";
        canvas.width = 480;
        canvas.height = 380;

        let gridSize = 80;
        let gridOffset = 0;

        // Load saved data from localStorage
        function loadSavedData() {
            const savedBalance = localStorage.getItem('toncrash_balance');
            if (savedBalance) {
                balance = parseFloat(savedBalance);
            }

            const savedHistory = localStorage.getItem('toncrash_history');
            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }

            const savedTransactionHistory = localStorage.getItem('toncrash_transactions');
            if (savedTransactionHistory) {
                transactionHistory = JSON.parse(savedTransactionHistory);
            }

            const savedBetCount = localStorage.getItem('toncrash_betcount');
            if (savedBetCount) {
                betCount = parseInt(savedBetCount);
            }

            const savedBetHistory = localStorage.getItem('toncrash_bethistory');
            if (savedBetHistory) {
                betHistory = JSON.parse(savedBetHistory);
            }

            const savedInventory = localStorage.getItem('toncrash_inventory');
            if (savedInventory) {
                inventory = JSON.parse(savedInventory);
            }

            updateBalance();
            updateBetCounter();
            updateHistoryDisplay();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('toncrash_balance', balance.toString());
            localStorage.setItem('toncrash_history', JSON.stringify(history));
            localStorage.setItem('toncrash_transactions', JSON.stringify(transactionHistory));
            localStorage.setItem('toncrash_betcount', betCount.toString());
            localStorage.setItem('toncrash_bethistory', JSON.stringify(betHistory));
            localStorage.setItem('toncrash_inventory', JSON.stringify(inventory));
        }

        // Advanced crash point calculation algorithm
        function calculateCrashPoint(betAmount) {
            console.log(`Расчет для ставки #${betCount}, сумма: ${betAmount}`);
            
            // Проверка на скачок ставки (увеличение минимум в 2.5 раза)
            let hasBetSpike = false;
            if (betHistory.length > 0) {
                const lastBets = betHistory.slice(-10);
                const avgLastBets = lastBets.reduce((sum, bet) => sum + bet, 0) / lastBets.length;
                
                if (betAmount >= avgLastBets * 2.5 && !hasBetSpikeOccurred) {
                    hasBetSpike = true;
                    hasBetSpikeOccurred = true;
                    console.log(`Обнаружен скачок ставки! Среднее: ${avgLastBets.toFixed(2)}, текущее: ${betAmount}`);
                } else if (betAmount < avgLastBets * 2.5) {
                    hasBetSpikeOccurred = false;
                }
            }

            // Если есть скачок ставки - 75% шанс на 0.00x
            if (hasBetSpike) {
                if (Math.random() < 0.75) {
                    console.log('Скачок ставки -> 0.00x');
                    return 0.00;
                }
            }

            // Каждая 4-я или 5-я ставка должна быть 0
            if (betCount % 4 === 0 || betCount % 5 === 0) {
                console.log(`Ставка #${betCount} - каждая 4-я/5-я -> 0.00x`);
                return 0.00;
            }

            // Специальные правила для определенных номеров ставок
            if ([3, 4, 5, 8, 12].includes(betCount)) {
                console.log(`Ставка #${betCount} - обязательно 0.00x`);
                return 0.00;
            }

            // Первая ставка - 70% шанс на 4.00x
            if (betCount === 1) {
                if (Math.random() < 0.7) {
                    console.log('Первая ставка -> 4.00x (70% шанс)');
                    return 4.00;
                }
            }

            // Вторая ставка - 30% шанс на 4.00x
            if (betCount === 2) {
                if (Math.random() < 0.3) {
                    console.log('Вторая ставка -> 4.00x (30% шанс)');
                    return 4.00;
                }
            }

            // 6, 7, 9 ставки - 60% шанс от 1.30 до 3.8
            if ([6, 7, 9].includes(betCount)) {
                if (Math.random() < 0.6) {
                    const multiplierValue = 1.30 + Math.random() * (3.8 - 1.30);
                    console.log(`Ставка #${betCount} -> ${multiplierValue.toFixed(2)}x (60% шанс 1.30-3.8)`);
                    return multiplierValue;
                }
            }

            // 10, 11 ставки - 80% шанс от 1.05 до 2.5
            if ([10, 11].includes(betCount)) {
                if (Math.random() < 0.8) {
                    const multiplierValue = 1.05 + Math.random() * (2.5 - 1.05);
                    console.log(`Ставка #${betCount} -> ${multiplierValue.toFixed(2)}x (80% шанс 1.05-2.5)`);
                    return multiplierValue;
                }
            }

            // Если никакие специальные условия не сработали - обычный случайный множитель
            const randomMultiplier = 1 + Math.random() * 4;
            console.log(`Обычный случайный множитель -> ${randomMultiplier.toFixed(2)}x`);
            return randomMultiplier;
        }

        function updateBetCounter() {
            document.getElementById('betCounter').textContent = `Ставка #${betCount + 1}`;
        }

        function updateHistoryDisplay() {
            const historyStrip = document.getElementById('historyStrip');
            historyStrip.innerHTML = '';

            history.forEach(mult => {
                const item = document.createElement('div');
                item.className = 'history-item';

                if (mult < 2.00) {
                    item.classList.add('low');
                } else if (mult < 7.00) {
                    item.classList.add('medium');
                } else {
                    item.classList.add('high');
                }

                item.textContent = mult.toFixed(2) + 'x';
                historyStrip.appendChild(item);
            });
        }

        function initializeGame() {
            document.getElementById('loadingGif').src = rocketGif;
            document.getElementById('rocket').src = rocketGif;

            // Load saved data
            loadSavedData();

            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                checkUsername();
            }, 2000);
        }

        function checkUsername() {
            const username = localStorage.getItem('telegramUsername');
            if (!username) {
                document.getElementById('usernameModal').classList.add('show');
                document.getElementById('overlayDim').classList.add('show');
            }
        }

        function saveUsername() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username) {
                localStorage.setItem('telegramUsername', username);
                document.getElementById('usernameModal').classList.remove('show');
                document.getElementById('overlayDim').classList.remove('show');
            } else {
                alert('Пожалуйста, введите ник');
            }
        }

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.lineWidth = 1;

            const cols = Math.ceil(canvas.width / gridSize) + 2;
            const rows = Math.ceil(canvas.height / gridSize) + 2;

            const offset = isAtCenter ? (gridOffset + backgroundOffset) : gridOffset;

            for (let i = -1; i < cols; i++) {
                ctx.beginPath();
                ctx.moveTo(i * gridSize - offset, 0);
                ctx.lineTo(i * gridSize - offset, canvas.height);
                ctx.stroke();
            }

            for (let i = -1; i < rows; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * gridSize - offset);
                ctx.lineTo(canvas.width, i * gridSize - offset);
                ctx.stroke();
            }
        }

        function animateGrid() {
            if (gameRunning) {
                if (!isAtCenter) {
                    gridOffset += 0.2;
                    if (gridOffset >= gridSize) {
                        gridOffset = 0;
                    }
                } else {
                    backgroundOffset += 2;
                    if (backgroundOffset >= gridSize) {
                        backgroundOffset = 0;
                    }
                }
                gridSize = Math.max(40, 80 - multiplier * 2);
            }
            drawGrid();
        }

        setInterval(animateGrid, 16);

        function getGiftImage(amount) {
            if (amount === 0.15) return 'https://png.klev.club/uploads/posts/2024-05/png-klev-club-n5p4-p-emodzi-s-serdechkami-png-3.png';
            if (amount === 0.25) return 'https://i.postimg.cc/j2CmHdjw/9017120-imgwebp-Photoroom.png';
            if (amount === 0.50) return 'https://i.postimg.cc/cHk5LycB/Snimok-ekrana-2025-10-04-233431-Photoroom.png';
            if (amount === 1) return 'https://i.postimg.cc/9MMc7jqT/Snimok-ekrana-2025-11-23-142822-Photoroom.png';
            if (amount === 5) return 'https://i.postimg.cc/YC8PsWmg/ezgif-7ca5592ac5dc0d54.gif';
            if (amount === 10) return 'https://i.postimg.cc/YC8PsWmg/ezgif-7ca5592ac5dc0d54.gif';
            if (amount === 50) return 'https://i.postimg.cc/jS2VchSm/ezgif-78c292e779aaf7ba.gif';
            if (amount === 100) return 'https://i.postimg.cc/d3BRV8FN/ezgif-708ecbacda95219b.gif';
            if (amount > 100) return 'https://i.postimg.cc/d3tkngML/Gi-S7Cq-WXMAA8KMN.jpg';
            if (amount >= 1) return 'https://i.postimg.cc/hG4Bkqsr/ezgif-1f925d4c46d6c39d.gif';
            return 'https://i.postimg.cc/Rq567hTG/1f4b0.png';
        }

        function updateHistory(crashMultiplier) {
            history.unshift(crashMultiplier);
            if (history.length > 20) {
                history.pop();
            }
            updateHistoryDisplay();
            saveData();
        }

        function openHistoryModal() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (transactionHistory.length === 0) {
                historyList.innerHTML = '<div class="inventory-placeholder">История транзакций пуста</div>';
            } else {
                transactionHistory.forEach(transaction => {
                    const div = document.createElement('div');
                    div.className = 'history-item-row';
                    div.innerHTML = `
                        <div>
                            <span class="history-item-type ${transaction.type}">${transaction.label}</span>
                            <div style="font-size: 12px; color: #888; margin-top: 4px;">${transaction.date}</div>
                        </div>
                        <div style="font-weight: 600; display: flex; align-items: center; gap: 4px;">
                            ${transaction.amount.toFixed(2)}
                            <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
                        </div>
                    `;
                    historyList.appendChild(div);
                });
            }

            document.getElementById('historyModal').classList.add('show');
            document.getElementById('overlayDim').classList.add('show');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('show');
            document.getElementById('overlayDim').classList.remove('show');
        }

        function addTransaction(type, amount) {
            const labels = {
                'deposit': 'Пополнение',
                'withdraw': 'Вывод',
                'bet': 'Ставка',
                'win': 'Выигрыш'
            };

            transactionHistory.unshift({
                type: type,
                label: labels[type] || type,
                amount: amount,
                date: new Date().toLocaleString('ru-RU')
            });

            if (transactionHistory.length > 50) {
                transactionHistory.pop();
            }
            saveData();
        }

        document.getElementById('promoInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const code = this.value.trim();
                let amount = 0;

                if (code.endsWith('ZV')) {
                    amount = parseInt(code.replace('ZV', '')) / 100;
                } else if (code.endsWith('TN')) {
                    amount = parseInt(code.replace('TN', '')) / 100;
                } else if (code.endsWith('VIP')) {
                    amount = parseInt(code.replace('VIP', '')) / 100;
                }

                if (amount > 0 && amount <= 100) {
                    inventory.push({
                        amount: amount,
                        image: getGiftImage(amount)
                    });
                    alert('Подарок добавлен в инвентарь!');
                    this.value = '';
                    saveData();
                }
            }
        });

        function openBetModal() {
            document.getElementById('betModal').classList.add('show');
            document.getElementById('overlayDim').classList.add('show');
        }

        function closeBetModal() {
            document.getElementById('betModal').classList.remove('show');
            document.getElementById('overlayDim').classList.remove('show');
        }

        function switchTab(tab) {
            if (tab === 'ton') {
                document.getElementById('tonTab').classList.add('active');
                document.getElementById('inventoryTab').classList.remove('active');
                document.getElementById('tonContent').style.display = 'block';
                document.getElementById('inventoryContent').style.display = 'none';
            } else {
                document.getElementById('tonTab').classList.remove('active');
                document.getElementById('inventoryTab').classList.add('active');
                document.getElementById('tonContent').style.display = 'none';
                document.getElementById('inventoryContent').style.display = 'block';
                updateInventoryDisplay();
            }
        }

        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            const placeholder = document.getElementById('inventoryPlaceholder');
            const giftBetButton = document.getElementById('giftBetButton');

            if (inventory.length === 0) {
                placeholder.style.display = 'block';
                grid.style.display = 'none';
                giftBetButton.style.display = 'none';
            } else {
                placeholder.style.display = 'none';
                grid.style.display = 'grid';
                giftBetButton.style.display = 'block';
                grid.innerHTML = '';

                inventory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'gift-item';
                    div.innerHTML = `
                        <img src="${item.image}" alt="Gift">
                        <div class="gift-value">
                            ${item.amount.toFixed(2)}
                            <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
                        </div>
                    `;
                    div.onclick = () => selectGift(index);
                    grid.appendChild(div);
                });
            }
        }

        let selectedGift = null;

        function selectGift(index) {
            selectedGift = index;
            const items = document.querySelectorAll('.gift-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function toggleAutoCash() {
            autoCash = !autoCash;
            document.getElementById('autoCashToggle').classList.toggle('active');
            document.getElementById('autoCashAmount').style.display = autoCash ? 'block' : 'none';
        }

        function placeBet() {
            const amount = parseFloat(document.getElementById('betAmount').value);
            if (amount > balance) {
                alert('Недостаточно средств');
                return;
            }

            balance -= amount;
            betCount++;
            
            // Добавляем ставку в историю последних 10
            betHistory.push(amount);
            if (betHistory.length > 10) {
                betHistory.shift();
            }

            addTransaction('bet', amount);

            const betData = {
                amount: amount,
                type: 'ton'
            };

            if (autoCash) {
                autoCashAmount = parseFloat(document.getElementById('autoCashAmount').value);
            }

            if (gameRunning) {
                pendingBet = betData;
                alert('Ставка будет размещена в следующей игре');
            } else {
                currentBet = betData;
                addPlayerBet();
                document.getElementById('cashoutBtn').classList.add('show');
            }

            updateBalance();
            updateBetCounter();
            saveData();
            closeBetModal();
            document.getElementById('betButton').classList.add('hidden');
        }

        function placeGiftBet() {
            if (selectedGift === null) {
                alert('Выберите подарок');
                return;
            }

            const gift = inventory[selectedGift];
            betCount++;
            
            // Добавляем ставку в историю последних 10
            betHistory.push(gift.amount);
            if (betHistory.length > 10) {
                betHistory.shift();
            }

            const betData = {
                amount: gift.amount,
                type: 'gift',
                giftIndex: selectedGift
            };

            inventory.splice(selectedGift, 1);
            selectedGift = null;

            if (gameRunning) {
                pendingBet = betData;
                alert('Ставка будет размещена в следующей игре');
            } else {
                currentBet = betData;
                addPlayerBet();
                document.getElementById('cashoutBtn').classList.add('show');
            }

            updateBetCounter();
            saveData();
            closeBetModal();
            document.getElementById('betButton').classList.add('hidden');
        }

        function addPlayerBet() {
            const username = localStorage.getItem('telegramUsername') || 'Player';
            players.unshift({
                name: username,
                bet: currentBet.amount,
                cashout: null,
                isPlayer: true
            });
            updatePlayersDisplay();
        }

        function cashOut() {
            if (currentBet && gameRunning) {
                const winAmount = currentBet.amount * multiplier;
                balance += winAmount;
                addTransaction('win', winAmount);
                updateBalance();
                showWinModal(winAmount);
                saveData();

                const playerIndex = players.findIndex(p => p.isPlayer);
                if (playerIndex !== -1) {
                    players[playerIndex].cashout = winAmount;
                }

                currentBet = null;
                document.getElementById('cashoutBtn').classList.remove('show');
                document.getElementById('betButton').classList.remove('hidden');
                updatePlayersDisplay();
            }
        }

        function showWinModal(amount) {
            const amountElement = document.getElementById('winAmount');
            amountElement.innerHTML = `
                ${amount.toFixed(2)}
                <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
            `;
            document.getElementById('winGift').src = getGiftImage(amount);
            document.getElementById('winModal').classList.add('show');
        }

        function closeWinModal() {
            document.getElementById('winModal').classList.remove('show');
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').classList.add('show');
            document.getElementById('overlayDim').classList.add('show');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('show');
            document.getElementById('overlayDim').classList.remove('show');
        }

        function switchPaymentTab(tab) {
            if (tab === 'deposit') {
                document.getElementById('depositTab').classList.add('active');
                document.getElementById('withdrawTab').classList.remove('active');
                document.getElementById('depositContent').style.display = 'block';
                document.getElementById('withdrawContent').style.display = 'none';
            } else {
                document.getElementById('depositTab').classList.remove('active');
                document.getElementById('withdrawTab').classList.add('active');
                document.getElementById('depositContent').style.display = 'none';
                document.getElementById('withdrawContent').style.display = 'block';
            }
        }

        function withdraw() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value;

            if (amount > balance) {
                alert('Недостаточно средств');
                return;
            }

            if (!address) {
                alert('Введите адрес кошелька');
                return;
            }

            balance -= amount;
            addTransaction('withdraw', amount);
            updateBalance();
            saveData();
            alert('Запрос на вывод отправлен');
            closePaymentModal();
        }

        function updateBalance() {
            const balanceElement = document.getElementById('balance');
            balanceElement.innerHTML = `
                ${balance.toFixed(2)}
                <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
            `;
        }

        function animateTotalAmount(targetAmount) {
            const element = document.getElementById('totalAmount');
            const duration = 3000;
            const startTime = Date.now();
            const startAmount = 0;

            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const currentAmount = startAmount + (targetAmount - startAmount) * easeOutCubic;

                element.textContent = currentAmount.toFixed(2);

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            update();
        }

        function generatePlayers() {
            players = [];
            totalBetAmount = 0;

            for (let i = 0; i < 9; i++) {
                const betAmount = 0.1 + Math.random() * 2.9;
                totalBetAmount += betAmount;
                players.push({
                    name: usernames[Math.floor(Math.random() * usernames.length)],
                    bet: betAmount,
                    cashout: null,
                    isPlayer: false
                });
            }

            document.getElementById('onlineCount').textContent = players.length;
            animateTotalAmount(totalBetAmount);
            updatePlayersDisplay();
        }

        function updatePlayersDisplay() {
            const container = document.getElementById('playersList');
            container.innerHTML = '';

            players.forEach((player) => {
                const div = document.createElement('div');
                div.className = 'player-item';

                if (player.isPlayer) {
                    div.classList.add('highlight');
                }

                if (player.cashout !== null) {
                    div.classList.add('cashed-out');
                } else if (!gameRunning && player.cashout === null && players.some(p => p.cashout !== null)) {
                    div.classList.add('lost');
                }

                const cashoutAmount = player.cashout || (gameRunning ? player.bet * multiplier : 0);
                div.innerHTML = `
                    <div class="player-left">
                        <span class="player-name">${player.name}</span>
                        <span class="player-bet">
                            ${player.bet.toFixed(2)}
                            <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
                        </span>
                    </div>
                    <div class="player-right">
                        <span class="player-cashout">
                            ${cashoutAmount.toFixed(2)}
                            <img src="https://ton.app/assets/images/what-is-ton/ton-logo.png" alt="TON" class="ton-logo">
                        </span>
                        <img class="gift-icon" src="${getGiftImage(cashoutAmount)}" alt="Gift">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function startCountdown() {
            document.getElementById('countdown').style.display = 'flex';
            document.getElementById('redLine').classList.add('break-blur');
            document.getElementById('rocket').classList.add('break-blur');
            document.getElementById('multiplier').classList.add('break-blur');
            linePoints = [];
            isAtCenter = false;
            backgroundOffset = 0;

            if (pendingBet) {
                currentBet = pendingBet;
                pendingBet = null;
                addPlayerBet();
                document.getElementById('cashoutBtn').classList.add('show');
                document.getElementById('betButton').classList.add('hidden');
            }

            for (let i = 5; i > 0; i--) {
                document.getElementById('countdownNumber').textContent = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            document.getElementById('countdown').style.display = 'none';
            document.getElementById('redLine').classList.remove('break-blur');
            document.getElementById('rocket').classList.remove('break-blur');
            document.getElementById('multiplier').classList.remove('break-blur');
            startGame();
        }

        function updateWavyLine() {
            if (linePoints.length < 2) return;

            const canvasHeight = 380;
            let pathData = `M 0 ${canvasHeight}`;

            for (let i = 0; i < linePoints.length; i++) {
                pathData += ` L ${linePoints[i].x} ${canvasHeight - linePoints[i].y}`;
            }

            document.getElementById('linePath').setAttribute('d', pathData);
        }

        function startGame() {
            gameRunning = true;
            multiplier = 1.00;
            gridSize = 80;
            gridOffset = 0;
            linePoints = [];
            isAtCenter = false;
            backgroundOffset = 0;

            if (currentBet) {
                document.getElementById('cashoutBtn').classList.add('show');
            }

            // Use advanced algorithm to calculate crash point
            const crashPoint = currentBet ? calculateCrashPoint(currentBet.amount) : 1 + Math.random() * 9;
            const fixedDuration = 8000;
            const startTime = Date.now();

            const maxHeight = 380 * 0.5;
            const centerX = 240;

            const interval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / fixedDuration;

                multiplier = 1 + (crashPoint - 1) * progress;

                if (multiplier >= crashPoint) {
                    multiplier = crashPoint;
                    clearInterval(interval);
                    endGame();
                    return;
                }

                document.getElementById('multiplier').textContent = multiplier.toFixed(2) + 'x';

                const heightProgress = Math.min(progress * 1.5, 1);
                const currentHeight = heightProgress * maxHeight;

                const waveAmplitude = 15;
                const waveFrequency = 0.15;
                const wave = Math.sin(linePoints.length * waveFrequency) * waveAmplitude;
                const wave2 = Math.cos(linePoints.length * 0.1) * (waveAmplitude * 0.5);

                let xPos;
                if (!isAtCenter) {
                    xPos = 20 + linePoints.length * 3;
                    if (xPos >= centerX) {
                        isAtCenter = true;
                        xPos = centerX;
                    }
                } else {
                    xPos = centerX;
                }

                linePoints.push({
                    x: xPos,
                    y: currentHeight + wave + wave2
                });

                if (isAtCenter && linePoints.length > 80) {
                    const removeCount = linePoints.length - 80;
                    linePoints.splice(0, removeCount);

                    for (let i = 0; i < linePoints.length; i++) {
                        linePoints[i].x -= removeCount * 3;
                    }
                }

                updateWavyLine();
                updateRocketPosition(currentHeight + wave + wave2, xPos);
                updatePlayersDisplay();

                players.forEach((player) => {
                    if (!player.isPlayer && !player.cashout && Math.random() < 0.02) {
                        const cashoutMultiplier = multiplier * (0.8 + Math.random() * 0.2);
                        player.cashout = player.bet * cashoutMultiplier;
                    }
                });

                if (autoCash && currentBet && multiplier >= autoCashAmount) {
                    cashOut();
                }
            }, 50);
        }

        function updateRocketPosition(height, xPos) {
            const rocket = document.getElementById('rocket');
            rocket.style.bottom = (height - 10) + 'px';
            rocket.style.left = '50%';
            rocket.style.transform = 'translateX(-50%)';
        }

        function endGame() {
            gameRunning = false;
            isAtCenter = false;

            document.getElementById('multiplier').classList.add('crashed');
            document.getElementById('cashoutBtn').classList.remove('show');

            updateHistory(multiplier);

            if (currentBet) {
                document.getElementById('betButton').classList.remove('hidden');
                const playerIndex = players.findIndex(p => p.isPlayer);
                if (playerIndex !== -1 && !players[playerIndex].cashout) {
                    players[playerIndex].cashout = 0;
                }
                currentBet = null;
            }

            updatePlayersDisplay();

            setTimeout(() => {
                document.getElementById('multiplier').classList.remove('crashed');
                generatePlayers();
                startCountdown();
            }, 2000);
        }

        document.addEventListener('click', (e) => {
            if (e.target === document.getElementById('betModal')) {
                closeBetModal();
            }
            if (e.target === document.getElementById('paymentModal')) {
                closePaymentModal();
            }
            if (e.target === document.getElementById('historyModal')) {
                closeHistoryModal();
            }
            if (e.target === document.getElementById('overlayDim')) {
                closeBetModal();
                closePaymentModal();
                closeHistoryModal();
            }
        });

        // Initialize the game
        initializeGame();
        generatePlayers();
        startCountdown();
    </script>
</body>
</html>
